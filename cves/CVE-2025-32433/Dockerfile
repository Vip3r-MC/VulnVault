# Use a slimmer base image for faster builds
FROM ubuntu:22.04

# Set working directory
WORKDIR /app

# Install required packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git libssl-dev libncurses-dev \
    libgl1-mesa-dev libglu1-mesa-dev libpng-dev \
    libssh-dev libxml2-utils xsltproc fop curl \
    openssh-client autoconf && \
    rm -rf /var/lib/apt/lists/*

# Build Erlang/OTP from source
RUN git clone --depth 1 --branch OTP-26.2.5.10 https://github.com/erlang/otp.git /tmp/otp && \
    cd /tmp/otp && \
    ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    rm -rf /tmp/otp

# Create and compile Erlang source file
# Credits: ssh_server.erl code sourced from https://github.com/ProDefense/CVE-2025-32433/blob/main/ssh_server.erl
RUN printf '%s\n' \
    '-module(ssh_server).' \
    '-export([start/0]).' \
    '' \
    'start() ->' \
    '    io:format("Starting vulnerable SSH server~n"),' \
    '    application:ensure_all_started(ssh),' \
    '    case ssh:daemon(2222, [' \
    '        {system_dir, "/app/ssh_keys"},' \
    '        {auth_methods, "password"},' \
    '        {pwdfun, fun(User, Pass) ->' \
    '            io:format("Login attempt ~p/~p~n", [User, Pass]),' \
    '            false' \
    '        end}' \
    '    ]) of' \
    '        {ok, Pid} ->' \
    '            io:format("SSH Daemon started successfully. Pid: ~p~n", [Pid]);' \
    '        {error, Reason} ->' \
    '            io:format("Failed to start SSH daemon: ~p~n", [Reason])' \
    '    end.' > ssh_server.erl

RUN erlc ssh_server.erl

# Generate RSA keys that Erlang can use
RUN mkdir /app/ssh_keys && \
    ssh-keygen -t rsa -b 2048 -m PEM -f /app/ssh_keys/ssh_host_rsa_key -N "" && \
    ssh-keygen -y -f /app/ssh_keys/ssh_host_rsa_key > /app/ssh_keys/ssh_host_rsa_key.pub

# Expose SSH server port
EXPOSE 2222

# Start Erlang node with the SSH server module
CMD ["erl", "-noshell", "-pa", "/app", "-s", "ssh_server", "start"]
